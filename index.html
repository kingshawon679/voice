<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slowed + Reverb Song Editor</title>
  <style>
    :root{
      --bg:#0d0f1a;--card:#161b2a;--muted:#94a3b8;--accent:#7c3aed;--accent2:#06b6d4
    }
    html,body{height:100%;margin:0;font-family:'Inter',sans-serif}
    body{background:linear-gradient(135deg,#0d0f1a,#1e2238);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:28px}
    .wrap{width:1100px;max-width:98%;background:var(--card);border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,.7);}
    h1{text-align:center;font-size:26px;margin-bottom:20px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:20px}
    .panel{background:rgba(255,255,255,0.03);padding:18px;border-radius:14px;backdrop-filter:blur(8px);}
    .controls{display:grid;gap:14px}
    label{font-size:14px;color:var(--muted)}
    input[type="range"]{width:100%}
    .row{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s}
    button:hover{background:#6d28d9}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1)}
    .filebox{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:13px;color:var(--muted)}
    .footer{margin-top:10px;font-size:13px;color:var(--muted)}
    .preset{display:flex;gap:6px;flex-wrap:wrap}
    .preset button{background:transparent;border:1px solid rgba(255,255,255,0.1);padding:6px 10px;border-radius:8px;color:var(--muted)}
    textarea{width:100%;height:90px;background:transparent;border:1px dashed rgba(255,255,255,0.1);color:var(--muted);padding:8px;border-radius:8px}
    audio{width:100%;margin-top:8px;border-radius:12px;background:#000;box-shadow:0 4px 14px rgba(0,0,0,.6)}
    .playerBox{padding:14px;background:linear-gradient(145deg,#111827,#1f2937);border-radius:14px;box-shadow:inset 0 0 10px rgba(0,0,0,.6)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üé∂ Slowed + Reverb Song Editor üéß</h1>
    <div class="grid">
      <div class="panel">
        <div class="filebox">
          <input id="file" type="file" accept="audio/*" />
          <button id="loadSample" class="ghost">Load Demo</button>
          <button id="clear" class="ghost">Clear</button>
        </div>

        <div class="controls">
          <div>
            <label>Slowed (Playback Rate): <span id="rateLabel">0.80</span>x</label>
            <input id="rate" type="range" min="0.4" max="1.0" step="0.01" value="0.8">
          </div>

          <div>
            <label>Reverb (Wet Mix): <span id="reverbLabel">0.35</span></label>
            <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.35">
          </div>

          <div>
            <label>Bass Boost (Gain): <span id="bassLabel">1.0</span>x</label>
            <input id="bass" type="range" min="0" max="3" step="0.1" value="1">
          </div>

          <div class="preset">
            <label>Presets:</label>
            <button data-rate="0.65" data-rev="0.6" data-bass="1.5">Deep Sleep</button>
            <button data-rate="0.85" data-rev="0.25" data-bass="1.2">Chill</button>
            <button data-rate="0.5" data-rev="0.8" data-bass="2">Ambient</button>
          </div>

          <div class="row">
            <button id="play">‚ñ∂ Preview</button>
            <button id="stop" class="ghost">‚èπ Stop</button>
            <button id="render">üíæ Download Edited Song</button>
          </div>

          <div class="footer">For best performance use Chrome/Edge on desktop. Download will be a WAV file.</div>
        </div>

        <div style="margin-top:12px">
          <label>Status</label>
          <textarea id="log" readonly></textarea>
        </div>
      </div>

      <div class="panel playerBox">
        <div class="small">üéµ Preview Player</div>
        <audio id="preview" controls></audio>
      </div>
    </div>
  </div>

<script>
let audioCtx = null;
let originalBuffer = null;
let convolverBuffer = null;
let playingNodes = [];
let convolverIRProvided = false;

const fileEl = document.getElementById('file');
const preview = document.getElementById('preview');
const rateEl = document.getElementById('rate');
const reverbEl = document.getElementById('reverb');
const bassEl = document.getElementById('bass');
const playBtn = document.getElementById('play');
const stopBtn = document.getElementById('stop');
const renderBtn = document.getElementById('render');
const logEl = document.getElementById('log');
const rateLabel = document.getElementById('rateLabel');
const reverbLabel = document.getElementById('reverbLabel');
const bassLabel = document.getElementById('bassLabel');

function log(s){logEl.value += s+"\n"; logEl.scrollTop = logEl.scrollHeight}
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }

fileEl.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  ensureAudioCtx();
  const arr = await f.arrayBuffer();
  originalBuffer = await audioCtx.decodeAudioData(arr.slice(0));
  preview.src = URL.createObjectURL(new Blob([arr]));
  log('Loaded: '+f.name);
});

rateEl.addEventListener('input',()=>rateLabel.textContent=parseFloat(rateEl.value).toFixed(2));
reverbEl.addEventListener('input',()=>reverbLabel.textContent=parseFloat(reverbEl.value).toFixed(2));
bassEl.addEventListener('input',()=>bassLabel.textContent=parseFloat(bassEl.value).toFixed(1));

document.querySelectorAll('.preset button').forEach(b=>{
  b.addEventListener('click',()=>{
    rateEl.value=b.dataset.rate;reverbEl.value=b.dataset.rev;bassEl.value=b.dataset.bass;
    rateLabel.textContent=parseFloat(rateEl.value).toFixed(2);
    reverbLabel.textContent=parseFloat(reverbEl.value).toFixed(2);
    bassLabel.textContent=parseFloat(bassEl.value).toFixed(1);
  });
});

playBtn.addEventListener('click',async()=>{
  if(!originalBuffer){log('No audio loaded');return}
  await playPreview();
});
stopBtn.addEventListener('click',stopAll);

async function createConvolver(){
  ensureAudioCtx();
  const length = audioCtx.sampleRate*3.5;
  const ir = audioCtx.createBuffer(2,length,audioCtx.sampleRate);
  for(let ch=0;ch<2;ch++){
    const data=ir.getChannelData(ch);
    for(let i=0;i<length;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/length);
  }
  convolverBuffer=ir;
  return ir;
}

async function playPreview(){
  stopAll();
  const playbackRate=parseFloat(rateEl.value);
  const wet=parseFloat(reverbEl.value);
  const bassGain=parseFloat(bassEl.value);
  const src=audioCtx.createBufferSource();
  src.buffer=originalBuffer;
  src.playbackRate.value=playbackRate;

  const dryGain=audioCtx.createGain();dryGain.gain.value=1-wet;
  const conv=audioCtx.createConvolver();conv.buffer=convolverBuffer||await createConvolver();
  const wetGain=audioCtx.createGain();wetGain.gain.value=wet;
  const bass=audioCtx.createBiquadFilter();bass.type='lowshelf';bass.frequency.value=200;bass.gain.value=15*(bassGain-1);

  src.connect(bass);
  bass.connect(dryGain).connect(audioCtx.destination);
  bass.connect(conv).connect(wetGain).connect(audioCtx.destination);

  src.start();
  playingNodes.push(src);
  log('Previewing with rate '+playbackRate+', reverb '+wet+', bass '+bassGain);
}

function stopAll(){playingNodes.forEach(n=>{try{n.stop()}catch(e){}});playingNodes=[];}

renderBtn.addEventListener('click',async()=>{
  if(!originalBuffer){log('No audio loaded');return}
  renderBtn.disabled=true;log('Rendering...');
  const rate=parseFloat(rateEl.value),wet=parseFloat(reverbEl.value),bassGain=parseFloat(bassEl.value);
  const sampleRate=44100;
  const outLen=Math.ceil(originalBuffer.duration/rate*sampleRate);
  const offline=new OfflineAudioContext(2,outLen,sampleRate);

  const src=offline.createBufferSource();src.buffer=originalBuffer;src.playbackRate.value=rate;
  const dry=offline.createGain();dry.gain.value=1-wet;
  const conv=offline.createConvolver();conv.buffer=await createConvolver();
  const wetG=offline.createGain();wetG.gain.value=wet;
  const bass=offline.createBiquadFilter();bass.type='lowshelf';bass.frequency.value=200;bass.gain.value=15*(bassGain-1);

  src.connect(bass);
  bass.connect(dry).connect(offline.destination);
  bass.connect(conv).connect(wetG).connect(offline.destination);

  src.start(0);
  const rendered=await offline.startRendering();
  const wav=bufferToWavBlob(rendered);
  const url=URL.createObjectURL(wav);
  downloadURL(url,'edited_song.wav');
  log('Rendered and download started');
  renderBtn.disabled=false;
});

function bufferToWavBlob(buffer){
  const n=buffer.numberOfChannels,l=buffer.length* n*2+44;
  const arr=new ArrayBuffer(l);const view=new DataView(arr);
  writeStr(view,0,'RIFF');view.setUint32(4,36+buffer.length*n*2,true);writeStr(view,8,'WAVE');
  writeStr(view,12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,n,true);
  view.setUint32(24,buffer.sampleRate,true);view.setUint32(28,buffer.sampleRate*n*2,true);view.setUint16(32,n*2,true);view.setUint16(34,16,true);
  writeStr(view,36,'data');view.setUint32(40,buffer.length*n*2,true);
  let offset=44;const ch=[];for(let i=0;i<n;i++)ch.push(buffer.getChannelData(i));
  for(let i=0;i<buffer.length;i++)for(let j=0;j<n;j++){let s=Math.max(-1,Math.min(1,ch[j][i]));s=s<0?s*0x8000:s*0x7FFF;view.setInt16(offset,s,true);offset+=2}
  return new Blob([view],{type:'audio/wav'});
}
function writeStr(view,o,s){for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
function downloadURL(u,f){const a=document.createElement('a');a.href=u;a.download=f;a.click();setTimeout(()=>URL.revokeObjectURL(u),10000)}
</script>
</body>
</html>
